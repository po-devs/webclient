<html>
    <head>
        <meta charset="utf-8">
        <title>Pok√©mon Online Webclient</title>
        <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.1/themes/base/jquery-ui.css" />
        <link rel="stylesheet" href="libs/alertify.css" />
        <link rel="stylesheet" href="css/webclient.css" />
        <script src="http://code.jquery.com/jquery-latest.min.js"></script>
        <script src="http://code.jquery.com/ui/1.9.2/jquery-ui.min.js"></script>
        <script src="js/websocket.js"></script>
        <script src="libs/md5.js"></script>
        <script src="libs/querystring.js"></script>
        <script src="js/channels.js"></script>
        <script src="js/formatting.js"></script>
        <script>
            $(function() {
                $("#channel-tabs").tabs();
                channels = new Channels();

                if (getQuerystring("autoconnect") === "true") {
                    initWebsocket();
                }
            });
        </script>
    </head>
    <body>
        <p>
            Relay Station
            <input type="text" id="url" value="ws://localhost:10508" onkeydown="if(event.keyCode==13) initWebsocket();" autofocus="autofocus"/>
            <button onClick="initWebsocket();">Connect</button>
            <button onClick="stopWebsocket();">Disconnect</button>
            <button onClick="checkSocket();">State</button>
        </p>
        <p class="client">
            <table>
                <tr>
                    <td>
                        <div id="announcement" class="announcement"></div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <div id="channel-tabs">
                            <ul>
                                <li><a href="#channel-0">Console</a></li>
                            </ul>
                            <div id="channel-0">
                                <div id="chatTextArea" class="textbox"></div>
                            </div>
                        </div>
                    </td>
                </tr>
            </table>
        </p>
        <p>
            <input type="text" id="inputText" cols="40" onkeydown="if(event.keyCode==13)sendMessage();" placeholder="Type your message here..."/>
            <button onClick="sendMessage();">Send</button>
        </p>
        <script type="text/javascript">

            var queryString = getQuerystring('relay');
            var Announcement = $("#announcement");

            if (queryString !== '') {
                $("#url").val("ws://" + queryString + (!isNaN(queryString.split(":")[1]) ? "" : ":10508"));
            }

            function displayMessage(message)
            {
                for (id in channels.channels) {
                    channels.channel(id).print(message);
                }
            }

            function sendMessage()
            {
                if (ws.initialized) {
                    var $inputText = $("#inputText");
                    var message = $inputText.val().split("\n");
                    var currentChannel = channels.current().id;
                    var x = 0,
                        length = message.length,
                        strToSend;

                    $inputText.val("");

                    for (; x < length; x++)  {
                        strToSend = "chat|" + JSON.stringify({channel: currentChannel, message: message[x]});
                        ws.send( strToSend );
                        console.log( "Message sent :", '"'+strToSend+'"' );
                    }
                } else {
                    displayMessage("ERROR: Connect to the relay station before sending a message.");
                }
            }

            var ws = new POWebSocket();
            var parseCommand;
            var relayIP;

            function initWebsocket()
            {
                var url = $("#url").val();
                try
                {
                    if (ws.state() === ws.states.connected) {
                        ws.disconnect();
                    }
                    displayMessage("Connecting to " + url);

                    relayIP = url.slice(5); //remove 'ws://'
                    relayIP = relayIP.substr(0, relayIP.lastIndexOf(":"));

                    ws.connect(url);

                    ws.on("open", function (event) {
                        displayMessage("CONNECTED");
                    }).on("close", function(event) {
                        displayMessage( "DISCONNECTED" );
                    }).on("message", function(event) {
                        console.log( "Message received :", event.data );

                        if (event.data.indexOf("|") != -1) {
                            parseCommand(event.data);
                        } else {
                            displayMessage( event.data );
                        }
                    }).on("error", function(event) {
                        displayMessage( 'ERROR: ' + event.data );
                    });
                }
                catch( exception )
                {
                    displayMessage( 'WebSocket Initialization - ERROR: ' + exception );
                }
            }

            function stopWebsocket()
            {
                ws.disconnect();
            }

            function checkSocket()
            {
                var stateStr = "UNKNOWN", states = ws.states, state = ws.state;
                if (ws.initialized)
                {
                    switch (state)
                    {
                        case states.connecting:
                            stateStr = "CONNECTING";
                            break;
                        case states.connected:
                            stateStr = "OPEN";
                            break;
                        case states.closing:
                            stateStr = "CLOSING";
                            break;
                        case states.closed:
                            stateStr = "CLOSED";
                            break;
                    }
                    displayMessage( "Websocket state: " + state + " ( " + stateStr + " )" );
                }
                else
                {
                    displayMessage( "Websocket is not initialized" );
                }
            }

            parseCommand = function(message) {
                var cmd = message.substr(0, message.indexOf("|"));
                var data = message.slice(message.indexOf("|")+1);

                if (cmd == "defaultserver") {
                    /* If the server is on the same IP as the relay, we display the server IP but
                        send localhost */
                    var server = data.replace("localhost", relayIP);

                    var serverQuerystring = getQuerystring("server");
                    if (serverQuerystring === "default") {
                        console.log("Message sent: '" + "connect|" + data + "'");
                        ws.send("connect|" + data);
                    } else if (serverQuerystring !== "") {
                        ws.send("connect|" + serverQuerystring + (!isNaN(serverQuerystring.split(":")[1]) ? '' : ':5080'));
                    } else {
                        alertify.prompt("Server to connect to (default " + server + ")", function (e, str) {
                            if (e) {
                                // after clicking OK
                                // str is the value from the textbox
                                if (str && str.indexOf(":") == -1) { str += ":5080"; }
                                var strToSend = "connect|" + (str ? str.replace(relayIP, "localhost") : data);
                                console.log("Message sent: '" + strToSend + "'");
                                ws.send(strToSend);
                            } else {
                                // after clicking Cancel
                                stopWebsocket();
                            }
                        });
                    }
                } else if (cmd == "connected") {
                    displayMessage("Connected to server!");

                    var data = {version: 1};
                    if (getQuerystring("user")) {
                        data.name = getQuerystring("user");
                        ws.send("login|"+JSON.stringify(data));
                    } else {
                        alertify.prompt("Username", function (e, str) {


                            if (e && str) {
                                data.name = str;
                            }

                            /* Optionnal parameters: away, color, ladder */
                            ws.send("login|"+JSON.stringify(data));
                        });
                    }
                } else if (cmd == "disconnected") {
                    displayMessage("Disconnected from server!");
                    Announcement.hide("slow");
                } else if (cmd == "msg" || cmd == "error") {
                    displayMessage(data);
                } else if (cmd == "chat") {
                    var params = JSON.parse(data);
                    var msg = params.message;

                    if (!params.html) {
                        msg = escapeHtml(msg);
                    } else {
                        msg = format(msg);
                    }

                    if (msg.indexOf(":")!=-1 && !params.html) {
                        var pref = msg.substr(0, msg.indexOf(":")+1);
                        if (pref == "Welcome Message:") {
                            pref = "<span class='welcome-message'>" + pref + "</span>";
                        }
                        msg = "<b>"+pref+"</b>"+msg.slice(msg.indexOf(":")+1);
                    }

                    if (params.channel == -1 && params.message[0] != "~") {
                        displayMessage(msg);
                    } else {
                        channels.channel(params.channel).print(msg);
                    }
                } else if (cmd == "challenge") {
                    alertify.pass("Please enter your password", function (e, str) {
                        if (e) {
                            // after clicking OK
                            // str is the value from the textbox
                            var hash = MD5(MD5(str)+data);
                            ws.send("auth|" + hash);
                        } else {
                            // after clicking Cancel
                            stopWebsocket();
                        }
                    });
                } else if (cmd == "announcement") {
                    Announcement.html(data);
                    format($("#announcement"));
                    Announcement = $("#announcement"); // Update

                    Announcement.css("visibility", "visible");
                    Announcement.show("slow");
                } else if (cmd == "channels") {
                    var params = JSON.parse(data);
                    channels.setNames(params);
                } else if (cmd == "newchannel") {
                    var params = JSON.parse(data);
                    channels.newChannel(params.id, params.name);
                } else if (cmd == "removechannel") {
                    channels.removeChannel(data);
                } else if (cmd == "channelnamechange") {
                    var params = JSON.parse(data);
                    channels.changeChannelName(params.id, params.name);
                }
            };

        </script>
    </body>
    <script src="libs/alertify.min.js"></script>
</html>
